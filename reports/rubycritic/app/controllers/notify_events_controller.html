<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>RubyCritic</title>
    <link href="../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <header class="project-header group">
      <h1 class="logo"><a href="../../overview.html" class="logo-link">RubyCritic</a></h1>
      <nav class="project-nav">
        <a href="../../overview.html" class="project-nav-item">Overview</a>
        <a href="../../code_index.html" class="project-nav-item">Code</a>
        <a href="../../smells_index.html" class="project-nav-item">Smells</a>
      </nav>
    </header>
    <div class="file-header group">
  <span class="rating-f circled-text circle ">F</span>
  <h2 class="file-name">NotifyEventsController</h2>

  <span class="file-committed-at">
    
      Updated <time class='js-timeago' datetime='2014-02-17 22:30:02 +0200'>2014-02-17 22:30:02 +0200</time>
    
  </span>

  <div class="file-stats group">
    <div class="file-stat">
      357 complexity
    </div>
    <div class="file-stat">
      32.5 complexity per method
    </div>
    <div class="file-stat">
      14 churn
    </div>
    <div class="file-stat">
      11 methods
    </div>
    <div class="file-stat">
      115 duplication
    </div>
  </div>

  
    <button id="js-toggle-smells" class="smells-toggle-button button">Toggle Smells</button>
  
</div>

<code class="prettyprint linenums lang-ruby file-code js-file-code">require &quot;awesome_print&quot;
require &#39;paint&#39;

class NotifyEventsController &lt; ApplicationController
  # GET /notify_events
  # GET /notify_events.json
  def index<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(DuplicateCode) Similar code found in 43 nodes                        <a href="bookmarks_controller.html#L4" class="js-smell-location">0</a>                  <a href="bookmarks_controller.html#L26" class="js-smell-location">1</a>                  <a href="event_properties_controller.html#L4" class="js-smell-location">2</a>                  <a href="event_properties_controller.html#L26" class="js-smell-location">3</a>                  <a href="event_resources_controller.html#L4" class="js-smell-location">4</a>                  <a href="event_resources_controller.html#L26" class="js-smell-location">5</a>                  <a href="event_types_controller.html#L4" class="js-smell-location">6</a>                  <a href="event_types_controller.html#L26" class="js-smell-location">7</a>                  <a href="field_types_controller.html#L4" class="js-smell-location">8</a>                  <a href="field_types_controller.html#L26" class="js-smell-location">9</a>                  <a href="field_validations_controller.html#L4" class="js-smell-location">10</a>                  <a href="field_validations_controller.html#L26" class="js-smell-location">11</a>                  <a href="fields_controller.html#L4" class="js-smell-location">12</a>                  <a href="fields_controller.html#L26" class="js-smell-location">13</a>                  <a href="menus_controller.html#L4" class="js-smell-location">14</a>                  <a href="notify_events_controller.html#L7" class="js-smell-location">15</a>                  <a href="notify_observer_properties_controller.html#L4" class="js-smell-location">16</a>                  <a href="notify_observer_properties_controller.html#L35" class="js-smell-location">17</a>                  <a href="notify_observers_controller.html#L4" class="js-smell-location">18</a>                  <a href="notify_observers_controller.html#L26" class="js-smell-location">19</a>                  <a href="notify_schedulers_controller.html#L4" class="js-smell-location">20</a>                  <a href="notify_schedulers_controller.html#L26" class="js-smell-location">21</a>                  <a href="notify_templates_controller.html#L4" class="js-smell-location">22</a>                  <a href="notify_templates_controller.html#L26" class="js-smell-location">23</a>                  <a href="permissions_controller.html#L4" class="js-smell-location">24</a>                  <a href="permissions_controller.html#L26" class="js-smell-location">25</a>                  <a href="recipients_controller.html#L4" class="js-smell-location">26</a>                  <a href="recipients_controller.html#L26" class="js-smell-location">27</a>                  <a href="recurrences_controller.html#L4" class="js-smell-location">28</a>                  <a href="recurrences_controller.html#L26" class="js-smell-location">29</a>                  <a href="resource_types_controller.html#L30" class="js-smell-location">30</a>                  <a href="resource_values_controller.html#L4" class="js-smell-location">31</a>                  <a href="resource_values_controller.html#L26" class="js-smell-location">32</a>                  <a href="resources_controller.html#L8" class="js-smell-location">33</a>                  <a href="roles_controller.html#L2" class="js-smell-location">34</a>                  <a href="roles_controller.html#L26" class="js-smell-location">35</a>                  <a href="table_cell_items_controller.html#L4" class="js-smell-location">36</a>                  <a href="table_filters_controller.html#L4" class="js-smell-location">37</a>                  <a href="table_headers_controller.html#L3" class="js-smell-location">38</a>                  <a href="table_templates_controller.html#L2" class="js-smell-location">39</a>                  <a href="table_templates_controller.html#L18" class="js-smell-location">40</a>                  <a href="users_controller.html#L32" class="js-smell-location">41</a>                  <a href="validators_controller.html#L10" class="js-smell-location">42</a>                  </span>  </li></ul>
    @notify_events = NotifyEvent.all
    # raise &quot;jhhkjhjkhjk&quot;
    respond_to do |format|
      format.html # index.html.erb
      format.json { render :json =&gt; @notify_events }
    end
  end

  # GET /notify_events/1
  # GET /notify_events/1.json
  def show<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(DuplicateCode) Similar code found in 22 nodes                        <a href="bookmarks_controller.html#L15" class="js-smell-location">0</a>                  <a href="event_properties_controller.html#L15" class="js-smell-location">1</a>                  <a href="event_resources_controller.html#L15" class="js-smell-location">2</a>                  <a href="event_types_controller.html#L15" class="js-smell-location">3</a>                  <a href="field_types_controller.html#L15" class="js-smell-location">4</a>                  <a href="field_validations_controller.html#L15" class="js-smell-location">5</a>                  <a href="fields_controller.html#L15" class="js-smell-location">6</a>                  <a href="menus_controller.html#L15" class="js-smell-location">7</a>                  <a href="notify_events_controller.html#L18" class="js-smell-location">8</a>                  <a href="notify_observer_properties_controller.html#L24" class="js-smell-location">9</a>                  <a href="notify_observers_controller.html#L15" class="js-smell-location">10</a>                  <a href="notify_schedulers_controller.html#L15" class="js-smell-location">11</a>                  <a href="notify_templates_controller.html#L15" class="js-smell-location">12</a>                  <a href="permissions_controller.html#L15" class="js-smell-location">13</a>                  <a href="recipients_controller.html#L15" class="js-smell-location">14</a>                  <a href="recurrences_controller.html#L15" class="js-smell-location">15</a>                  <a href="resource_values_controller.html#L15" class="js-smell-location">16</a>                  <a href="table_cell_items_controller.html#L15" class="js-smell-location">17</a>                  <a href="table_filters_controller.html#L15" class="js-smell-location">18</a>                  <a href="table_headers_controller.html#L12" class="js-smell-location">19</a>                  <a href="table_templates_controller.html#L10" class="js-smell-location">20</a>                  <a href="validators_controller.html#L21" class="js-smell-location">21</a>                  </span>  </li></ul>
    @notify_event = NotifyEvent.find(params[:id])

    respond_to do |format|
      format.html # show.html.erb
      format.json { render :json =&gt; @notify_event }
    end
  end

  # GET /notify_events/new
  # GET /notify_events/new.json
  def new
    @notify_event = NotifyEvent.new
    ap @notify_event
     
    respond_to do |format|
      format.html # new.html.erb
      format.json { render :json =&gt; @notify_event }
    end
  end

  # GET /notify_events/1/edit
  def edit<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(VeryHighComplexity) NotifyEventsController#edit has a flog score of 88          </span>  </li></ul>
    @notify_event = NotifyEvent.find(params[:id])
    @mapping = Mapping.where(&quot;notify_template_id=?&quot;, @notify_event.notify_template_id)
    @recipients = Recipient.where(&quot;notify_event_id=?&quot;, @notify_event.id)
    ap @recipients

    @parameters = @mapping.collect{ |el| el.template_parameter}<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(DuplicateMethodCall) NotifyEventsController#edit calls @mapping.collect 3 times                        <a href="notify_events_controller.html#L46" class="js-smell-location">0</a>                  <a href="notify_events_controller.html#L50" class="js-smell-location">1</a>                  <a href="notify_events_controller.html#L64" class="js-smell-location">2</a>                  </span>  </li></ul>
    if @notify_event.with_observer?
      properties = NotifyObserverProperty.where(&quot;notify_observer_id=?&quot;, @notify_event.notify_observer_id.to_i)
      @options = properties.collect{ |el| [el.name, el.id, {complex: false}] }<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(DuplicateMethodCall) NotifyEventsController#edit calls el.id 4 times                        <a href="notify_events_controller.html#L49" class="js-smell-location">0</a>                  <a href="notify_events_controller.html#L63" class="js-smell-location">1</a>                  <a href="notify_events_controller.html#L68" class="js-smell-location">2</a>                  <a href="notify_events_controller.html#L70" class="js-smell-location">3</a>                  </span>  </li>  <li class="smell old">    <span class="description">(DuplicateMethodCall) NotifyEventsController#edit calls el.name 4 times                        <a href="notify_events_controller.html#L49" class="js-smell-location">0</a>                  <a href="notify_events_controller.html#L63" class="js-smell-location">1</a>                  <a href="notify_events_controller.html#L68" class="js-smell-location">2</a>                  <a href="notify_events_controller.html#L70" class="js-smell-location">3</a>                  </span>  </li></ul>
      @selec = @mapping.collect{ |el| el.notify_observer_property_id}<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(DuplicateMethodCall) NotifyEventsController#edit calls @mapping.collect 3 times                        <a href="notify_events_controller.html#L46" class="js-smell-location">0</a>                  <a href="notify_events_controller.html#L50" class="js-smell-location">1</a>                  <a href="notify_events_controller.html#L64" class="js-smell-location">2</a>                  </span>  </li></ul>
      print @selec.inspect
    else
      properties = Resource.resources_by_event(@notify_event.event_id.to_i)
      # @options = [
      # [[&quot;Teachers&quot;, 1, {:complex=&gt;true}], [&quot;Teachers&quot;, 2, {:complex=&gt;true}],[&quot;Persons&quot;, 3, {:complex=&gt;true}]], 
      # [[&quot;Name of a Teacher&quot;, 1, {:complex=&gt;false}]], 
      # [[&quot;Teachers&quot;, 1, {:complex=&gt;true}], [&quot;Teachers&quot;, 2, {:complex=&gt;true}],[&quot;Persons&quot;, 3, {:complex=&gt;true}]],
      # [[&quot;Name of a Person&quot;, 3, {:complex=&gt;false}], [&quot;Teacher of a Person C&quot;, 4, {:complex=&gt;true}]],
      # [[&quot;Teachers&quot;, 1, {:complex=&gt;true}], [&quot;Teachers&quot;, 2, {:complex=&gt;true}],[&quot;Persons&quot;, 3, {:complex=&gt;true}]],
      # [[&quot;Name of a Person&quot;, 3, {:complex=&gt;false}], [&quot;Teacher of a Person C&quot;, 4, {:complex=&gt;true}]],
      # [[&quot;Name of a Teacher&quot;, 1, {:complex=&gt;false}]]
      # ]
      @options = properties.collect{ |el| [el.name, el.id, {complex: true}]}<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(DuplicateMethodCall) NotifyEventsController#edit calls el.id 4 times                        <a href="notify_events_controller.html#L49" class="js-smell-location">0</a>                  <a href="notify_events_controller.html#L63" class="js-smell-location">1</a>                  <a href="notify_events_controller.html#L68" class="js-smell-location">2</a>                  <a href="notify_events_controller.html#L70" class="js-smell-location">3</a>                  </span>  </li>  <li class="smell old">    <span class="description">(DuplicateMethodCall) NotifyEventsController#edit calls el.name 4 times                        <a href="notify_events_controller.html#L49" class="js-smell-location">0</a>                  <a href="notify_events_controller.html#L63" class="js-smell-location">1</a>                  <a href="notify_events_controller.html#L68" class="js-smell-location">2</a>                  <a href="notify_events_controller.html#L70" class="js-smell-location">3</a>                  </span>  </li></ul>
      @selec = @mapping.collect{ |el| el.resource_id}<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(DuplicateMethodCall) NotifyEventsController#edit calls @mapping.collect 3 times                        <a href="notify_events_controller.html#L46" class="js-smell-location">0</a>                  <a href="notify_events_controller.html#L50" class="js-smell-location">1</a>                  <a href="notify_events_controller.html#L64" class="js-smell-location">2</a>                  </span>  </li></ul>
      @alloptions= []
      @selec.each do |el|
        @alloptions &lt;&lt; @options
        @alloptions &lt;&lt; Resource.resource_fields_with_values_by_resource(el.split(&quot;,&quot;).shift).collect{ |el| [el.name, el.id, {complex: !el.resource_reference_id.nil?}] }<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(DuplicateMethodCall) NotifyEventsController#edit calls el.id 4 times                        <a href="notify_events_controller.html#L49" class="js-smell-location">0</a>                  <a href="notify_events_controller.html#L63" class="js-smell-location">1</a>                  <a href="notify_events_controller.html#L68" class="js-smell-location">2</a>                  <a href="notify_events_controller.html#L70" class="js-smell-location">3</a>                  </span>  </li>  <li class="smell old">    <span class="description">(DuplicateMethodCall) NotifyEventsController#edit calls el.name 4 times                        <a href="notify_events_controller.html#L49" class="js-smell-location">0</a>                  <a href="notify_events_controller.html#L63" class="js-smell-location">1</a>                  <a href="notify_events_controller.html#L68" class="js-smell-location">2</a>                  <a href="notify_events_controller.html#L70" class="js-smell-location">3</a>                  </span>  </li>  <li class="smell old">    <span class="description">(NilCheck) NotifyEventsController#edit performs a nil-check.          </span>  </li></ul>
        el.split(&quot;,&quot;)[1..-2].each do |el|
          @alloptions &lt;&lt; Resource.resource_fields_with_values_by_resource(ResourceValue.find(el).resource_reference_id).collect{ |el| [el.name, el.id, {complex: !el.resource_reference_id.nil?}] }<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(DuplicateMethodCall) NotifyEventsController#edit calls el.id 4 times                        <a href="notify_events_controller.html#L49" class="js-smell-location">0</a>                  <a href="notify_events_controller.html#L63" class="js-smell-location">1</a>                  <a href="notify_events_controller.html#L68" class="js-smell-location">2</a>                  <a href="notify_events_controller.html#L70" class="js-smell-location">3</a>                  </span>  </li>  <li class="smell old">    <span class="description">(DuplicateMethodCall) NotifyEventsController#edit calls el.name 4 times                        <a href="notify_events_controller.html#L49" class="js-smell-location">0</a>                  <a href="notify_events_controller.html#L63" class="js-smell-location">1</a>                  <a href="notify_events_controller.html#L68" class="js-smell-location">2</a>                  <a href="notify_events_controller.html#L70" class="js-smell-location">3</a>                  </span>  </li>  <li class="smell old">    <span class="description">(NestedIterators) NotifyEventsController#edit contains iterators nested 3 deep          </span>  </li></ul>
        end
      end
      @options = @alloptions
      # ap @options, options = {:index =&gt; false, :multiline  =&gt; false}
      # print @selec.inspect
      # @all_options = [@options]
      # ResourceValue.find(params[:id].to_i).resource_reference_id
      # @selec.split(&quot;,&quot;).each do |el|
      #   @all_options &lt;&lt; ResourceValue.find(el.to_i).resource_reference_id
      # end
    end

  end

  # POST /notify_events
  # POST /notify_events.json
  def create<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(VeryHighComplexity) NotifyEventsController#create has a flog score of 81          </span>  </li></ul>
    #raise params.inspect
    recipients = params[:notify_event].delete(:recipients_attributes) || []<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(DuplicateMethodCall) NotifyEventsController#create calls params[:notify_event] 4 times                        <a href="notify_events_controller.html#L89" class="js-smell-location">0</a>                  <a href="notify_events_controller.html#L91" class="js-smell-location">1</a>                  <a href="notify_events_controller.html#L98" class="js-smell-location">2</a>                  <a href="notify_events_controller.html#L109" class="js-smell-location">3</a>                  </span>  </li></ul>
    puts recipients.inspect
    mappings = params[:notify_event].delete(:mappings_attributes) || []<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(DuplicateMethodCall) NotifyEventsController#create calls params[:notify_event] 4 times                        <a href="notify_events_controller.html#L89" class="js-smell-location">0</a>                  <a href="notify_events_controller.html#L91" class="js-smell-location">1</a>                  <a href="notify_events_controller.html#L98" class="js-smell-location">2</a>                  <a href="notify_events_controller.html#L109" class="js-smell-location">3</a>                  </span>  </li></ul>
    success = false

#raise mappings.inspect
    #raise recipients.inspect
    # TODO: move to model and separeate to form layer
    ActiveRecord::Base.transaction do
      @notify_event = NotifyEvent.new(params[:notify_event])<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(DuplicateMethodCall) NotifyEventsController#create calls params[:notify_event] 4 times                        <a href="notify_events_controller.html#L89" class="js-smell-location">0</a>                  <a href="notify_events_controller.html#L91" class="js-smell-location">1</a>                  <a href="notify_events_controller.html#L98" class="js-smell-location">2</a>                  <a href="notify_events_controller.html#L109" class="js-smell-location">3</a>                  </span>  </li></ul>
      success = @notify_event.save
      puts &quot;success.inspect:&quot;+success.inspect
      
      recipients.each do |recipient|
        r = Recipient.new(recipient)<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(UncommunicativeVariableName) NotifyEventsController#create has the variable name 'r'          </span>  </li></ul>
        r.group_number = recipient[&quot;group_number&quot;]
        r.notify_event = @notify_event
        success = success &amp;&amp; r.save
      end

      template_ = NotifyTemplate.find(params[:notify_event][:notify_template_id])<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(DuplicateMethodCall) NotifyEventsController#create calls params[:notify_event] 4 times                        <a href="notify_events_controller.html#L89" class="js-smell-location">0</a>                  <a href="notify_events_controller.html#L91" class="js-smell-location">1</a>                  <a href="notify_events_controller.html#L98" class="js-smell-location">2</a>                  <a href="notify_events_controller.html#L109" class="js-smell-location">3</a>                  </span>  </li></ul>
      mappings.each do |mapping|
        m = Mapping.new()<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(UncommunicativeVariableName) NotifyEventsController#create has the variable name 'm'          </span>  </li></ul>
        str=&quot;&quot;
        mapping[&quot;notify_observer_property_id&quot;].each do |map|<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(NestedIterators) NotifyEventsController#create contains iterators nested 3 deep          </span>  </li></ul>
          str &lt;&lt; map[&quot;properties&quot;]+&quot;,&quot;
        end
        if params[&quot;event&quot;]==&quot;Event&quot;<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(DuplicateCode) Identical code found in 2 nodes                        <a href="notify_events_controller.html#L116" class="js-smell-location">0</a>                  <a href="notify_events_controller.html#L178" class="js-smell-location">1</a>                  </span>  </li></ul>
          m.resource_id =  str[0..-2]
        else
          m.notify_observer_property_id = str[0..-2]
        end
        m.template_parameter = mapping[&quot;template_parameter&quot;]
        m.notify_template = template_
        success = success &amp;&amp; m.save
      end

    end
      #raise params.inspect    
    respond_to do |format|
      if success
        # NotifyEventMailer.notify_event_email(@notify_event).deliver
        format.html { redirect_to @notify_event, :notice =&gt; &#39;Notify event was successfully created.&#39; }<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(DuplicateCode) Similar code found in 2 nodes                        <a href="notify_events_controller.html#L131" class="js-smell-location">0</a>                  <a href="notify_observers_controller.html#L52" class="js-smell-location">1</a>                  </span>  </li></ul>
        format.json { render :json =&gt; @notify_event, :status =&gt; created, :location =&gt; @notify_event }
      else
        #raise @notify_event.errors.inspect
        format.html { render :action =&gt; &quot;new&quot;, :notice =&gt; &#39;Notify event was not successfully created.&#39;}
        format.json { render :json =&gt; @notify_event.errors, :status =&gt; unprocessable_entity }
      end
    end
  end

  # PUT /notify_events/1
  # PUT /notify_events/1.json
  def update<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(VeryHighComplexity) NotifyEventsController#update has a flog score of 86          </span>  </li></ul>
    
    # ap @notify_event, options = {:index =&gt; false, :multiline =&gt; true}
    #raise params.inspect
    recipients = params[&quot;notify_event&quot;].delete(&quot;recipients_attributes&quot;)<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(DuplicateMethodCall) NotifyEventsController#update calls params["notify_event"] 5 times                        <a href="notify_events_controller.html#L147" class="js-smell-location">0</a>                  <a href="notify_events_controller.html#L149" class="js-smell-location">1</a>                  <a href="notify_events_controller.html#L154" class="js-smell-location">2</a>                  <a href="notify_events_controller.html#L160" class="js-smell-location">3</a>                  <a href="notify_events_controller.html#L171" class="js-smell-location">4</a>                  </span>  </li></ul>
    puts recipients.inspect
    mappings = params[&quot;notify_event&quot;].delete(&quot;mappings_attributes&quot;)<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(DuplicateMethodCall) NotifyEventsController#update calls params["notify_event"] 5 times                        <a href="notify_events_controller.html#L147" class="js-smell-location">0</a>                  <a href="notify_events_controller.html#L149" class="js-smell-location">1</a>                  <a href="notify_events_controller.html#L154" class="js-smell-location">2</a>                  <a href="notify_events_controller.html#L160" class="js-smell-location">3</a>                  <a href="notify_events_controller.html#L171" class="js-smell-location">4</a>                  </span>  </li></ul>

    @notify_event = NotifyEvent.find(params[&quot;id&quot;])
    @notify_event.event_id = nil
    @notify_event.notify_observer_id = nil
    @notify_event.update_attributes(params[&quot;notify_event&quot;])<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(DuplicateMethodCall) NotifyEventsController#update calls params["notify_event"] 5 times                        <a href="notify_events_controller.html#L147" class="js-smell-location">0</a>                  <a href="notify_events_controller.html#L149" class="js-smell-location">1</a>                  <a href="notify_events_controller.html#L154" class="js-smell-location">2</a>                  <a href="notify_events_controller.html#L160" class="js-smell-location">3</a>                  <a href="notify_events_controller.html#L171" class="js-smell-location">4</a>                  </span>  </li></ul>
    
    Recipient.where(&quot;notify_event_id=?&quot;,params[&quot;id&quot;]).each do |el|
      el.destroy
    end

    Mapping.where(&quot;notify_template_id=?&quot;, params[&quot;notify_event&quot;][&quot;notify_template_id&quot;]).each do |el|<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(DuplicateMethodCall) NotifyEventsController#update calls params["notify_event"] 5 times                        <a href="notify_events_controller.html#L147" class="js-smell-location">0</a>                  <a href="notify_events_controller.html#L149" class="js-smell-location">1</a>                  <a href="notify_events_controller.html#L154" class="js-smell-location">2</a>                  <a href="notify_events_controller.html#L160" class="js-smell-location">3</a>                  <a href="notify_events_controller.html#L171" class="js-smell-location">4</a>                  </span>  </li></ul>
      el.destroy
    end

    recipients.each do |recipient|
      r = Recipient.new(recipient)<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(UncommunicativeVariableName) NotifyEventsController#update has the variable name 'r'          </span>  </li></ul>
      r.group_number = recipient[&quot;group_number&quot;]
      r.notify_event = @notify_event
      r.save
    end

    template_ = NotifyTemplate.find(params[&quot;notify_event&quot;][&quot;notify_template_id&quot;])<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(DuplicateMethodCall) NotifyEventsController#update calls params["notify_event"] 5 times                        <a href="notify_events_controller.html#L147" class="js-smell-location">0</a>                  <a href="notify_events_controller.html#L149" class="js-smell-location">1</a>                  <a href="notify_events_controller.html#L154" class="js-smell-location">2</a>                  <a href="notify_events_controller.html#L160" class="js-smell-location">3</a>                  <a href="notify_events_controller.html#L171" class="js-smell-location">4</a>                  </span>  </li></ul>
    mappings.each do |mapping|
      m = Mapping.new()<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(UncommunicativeVariableName) NotifyEventsController#update has the variable name 'm'          </span>  </li></ul>
      str=&quot;&quot;
      mapping[&quot;notify_observer_property_id&quot;].each do |map|
        str &lt;&lt; map[&quot;properties&quot;]+&quot;,&quot;
      end
      if params[&quot;event&quot;]==&quot;Event&quot;<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(DuplicateCode) Identical code found in 2 nodes                        <a href="notify_events_controller.html#L116" class="js-smell-location">0</a>                  <a href="notify_events_controller.html#L178" class="js-smell-location">1</a>                  </span>  </li></ul>
        m.resource_id =  str[0..-2]
      else
        m.notify_observer_property_id = str[0..-2]
      end
      m.template_parameter = mapping[&quot;template_parameter&quot;]
      m.notify_template = template_
      m.save
    end 

    respond_to do |format|
      if @notify_event.update_attributes(params[:notify_event])
        format.html { redirect_to @notify_event, :notice =&gt; &#39;Notify event was successfully updated.&#39; }
        format.json { head :no_content }
      else
        format.html { render :action =&gt; &quot;edit&quot; }
        format.json { render :json =&gt; @notify_event.errors, :status =&gt; :unprocessable_entity }
      end
    end
  end

  # DELETE /notify_events/1
  # DELETE /notify_events/1.json
  def destroy<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(DuplicateCode) Similar code found in 23 nodes                        <a href="bookmarks_controller.html#L74" class="js-smell-location">0</a>                  <a href="event_properties_controller.html#L74" class="js-smell-location">1</a>                  <a href="event_resources_controller.html#L74" class="js-smell-location">2</a>                  <a href="event_types_controller.html#L74" class="js-smell-location">3</a>                  <a href="field_validations_controller.html#L74" class="js-smell-location">4</a>                  <a href="fields_controller.html#L74" class="js-smell-location">5</a>                  <a href="menus_controller.html#L80" class="js-smell-location">6</a>                  <a href="notify_events_controller.html#L201" class="js-smell-location">7</a>                  <a href="notify_observer_properties_controller.html#L84" class="js-smell-location">8</a>                  <a href="notify_observers_controller.html#L79" class="js-smell-location">9</a>                  <a href="notify_schedulers_controller.html#L74" class="js-smell-location">10</a>                  <a href="notify_templates_controller.html#L74" class="js-smell-location">11</a>                  <a href="permissions_controller.html#L74" class="js-smell-location">12</a>                  <a href="recipients_controller.html#L74" class="js-smell-location">13</a>                  <a href="recurrences_controller.html#L74" class="js-smell-location">14</a>                  <a href="resource_values_controller.html#L74" class="js-smell-location">15</a>                  <a href="roles_controller.html#L74" class="js-smell-location">16</a>                  <a href="table_cell_items_controller.html#L74" class="js-smell-location">17</a>                  <a href="table_filters_controller.html#L74" class="js-smell-location">18</a>                  <a href="table_headers_controller.html#L79" class="js-smell-location">19</a>                  <a href="table_templates_controller.html#L58" class="js-smell-location">20</a>                  <a href="users_controller.html#L102" class="js-smell-location">21</a>                  <a href="validators_controller.html#L81" class="js-smell-location">22</a>                  </span>  </li></ul>
    @notify_event = NotifyEvent.find(params[:id])
    @notify_event.destroy

    respond_to do |format|
      format.html { redirect_to notify_events_url }
      format.json { head :no_content }
    end
  end


  #TODO: move to model
  def show_property_mapping_content<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(HighComplexity) NotifyEventsController#show_property_mapping_content has a flog score of 35          </span>  </li></ul>
    ap @notify_event
    template = NotifyTemplate.find(params[:notify_template_id].to_i)
    parameters = template.body.scan(/\$\$\{([0-9a-zA-Z_-]+)\}/).flatten
    if params[:notify_observer_id] != &quot;&quot;
      properties = NotifyObserverProperty.where(&quot;notify_observer_id=?&quot;,params[:notify_observer_id].to_i)
      options = properties.collect{ |el| [el.name, el.id, {complex: false}] }
    else
      properties = Resource.resources_by_event(params[:event_id].to_i)
      options = options_for_parameters_mapping(properties){true}
    end
    render :partial =&gt; &quot;notify_event_property_mapping&quot;, :collection =&gt; parameters, :as =&gt; &#39;parameter&#39;, :locals =&gt; {:options =&gt; options}, :layout =&gt; false
  end

  def show_property_by_resource_value
    params[:id] = ResourceValue.find(params[:id].to_i).resource_reference_id
    show_property_by_resource
  end

  def show_property_by_resource<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(FeatureEnvy) NotifyEventsController#show_property_by_resource refers to el more than self          </span>  </li></ul>
    properties = Resource.resource_fields_with_values_by_resource(params[:id].to_i)
    options = properties.collect{ |el| [el.name, el.id, {complex: !el.resource_reference_id.nil?}] }<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(NilCheck) NotifyEventsController#show_property_by_resource performs a nil-check.          </span>  </li></ul>
    # options = options_for_parameters_mapping(properties){!el.resource_reference_id.nil?}
    render :partial =&gt; &quot;property_by_resource_value&quot;, :locals =&gt; {:options =&gt; options}, :layout =&gt; false
  end

  private

  def options_for_parameters_mapping(properties)<ul class="nocode smells js-smells">  <li class="smell old">    <span class="description">(FeatureEnvy) NotifyEventsController#options_for_parameters_mapping refers to el more than self          </span>  </li></ul>
    properties.collect{ |el| [el.name, el.id, {complex: yield}] } 
  end  

end
</code>

    <script src='../../assets/javascripts/jquery-2.1.0.js'></script>
    <script src='../../assets/javascripts/jquery.tablesorter-2.0.js'></script>
    <script src='../../assets/javascripts/jquery.floatThead-v1.2.7.js'></script>
    <script src='../../assets/javascripts/jquery.timeago-v1.4.1.js'></script>
    <script src='../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../assets/javascripts/jquery.scrollTo-1.4.11.js'></script>
    <script src='../../assets/javascripts/prettify-4-Mar-2013.js'></script>
    <script src='../../assets/javascripts/application.js'></script>
  </body>
</html>
